<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>wrenjs | foreign class</title>
</head>
<body>
<script type="module">
import * as Wren from "../out/wren.js";

await Wren.load();

// In this example we make our own class [Bytes] which stores 0 to 255 bytes.
// We'll store the values in Emscripten memory by telling Wren to allocate
// 1 + n bytes for us.

let vm = self.vm = new Wren.VM({
	// Define the class itself.
	bindForeignClassFn: (mod, cls) => {
		if (mod === "main" && cls === "Bytes") {
			return {
				allocate: (vm) => {
					let size = vm.getSlotDouble(1);

					// The layout will is [ length, v0, v1, v2, ... ].
					let ptr = vm.setSlotNewForeign(0, 0, size + 1);
					
					let u8 = new Uint8Array(vm.heap, ptr);
					u8[0] = size;
					u8 = u8.subarray(1, 1 + size);
					u8.fill(0);

					console.log("new bytes", u8.slice());
				},
				finalize: (ptr) => {
					console.log("destroy bytes!");
				},
			};
		} else {
			console.log(`unhandled foreignClass ${mod} ${cls}`);
		}
	},
	// Define methods on the class.
	bindForeignMethodFn: (mod, cls, isStatic, signature) => {
		if (mod === "main" && cls === "Bytes" && !isStatic && signature === "setValue(_,_)") {
			return (vm) => {
				let ptr = vm.getSlotForeign(0);

				let u8 = new Uint8Array(vm.heap, ptr);
				let size = u8[0];
				u8 = u8.subarray(1, 1 + size);

				let index = vm.getSlotDouble(1);
				let value = vm.getSlotDouble(2);

				if (index >= 0 && index < size) {
					u8[index] = value;

					console.log("update bytes", u8.slice());
				}
			};
		}
	},
});

vm.interpret("main", `
foreign class Bytes {
  construct new(size) {}

  foreign setValue(index, value)
}

// Make 4 bytes and put some numbers in them.
var b = Bytes.new(4)
b.setValue(0, 1)
b.setValue(1, 2)
b.setValue(2, 3)
b.setValue(3, 4)
b = null
`);

// Trigger finalizer for our object.
vm.collectGarbage();
</script>
</body>
</html>